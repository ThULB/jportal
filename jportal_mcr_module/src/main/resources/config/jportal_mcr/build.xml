<?xml version="1.0" encoding="UTF-8"?>
<project name="jportal_mcr" xmlns:mcr="antlib:org.mycore.buildtools">
	<import file="${basedir}/common-modules.xml" />
	<import file="${basedir}/build.xml" />

	<property name="module.directory" location="${ant.file}/.." />
	<property file="${module.directory}/build.properties" />
	<property name="module.jar" location="${build.lib}/${module.jar.name}" />

	<target name="create.default-rules" description="loads default acl rules for archive application">
		<echo>Default rules</echo>
		<antcall target="invoke.cli">
			<param name="cli.directory" value="${module.directory}/acl" />
			<param name="cli.command" value="process defaultrules-commands" />
		</antcall>
	</target>

	<target name="create.users">
		<echo>Create users and groups</echo>
		<antcall target="invoke.cli">
			<param name="cli.directory" value="${module.directory}/usersAndGroups" />
			<param name="cli.command" value="process usersAndGroups-commands" />
		</antcall>
	</target>

	<!-- CREATE WEB APPLICATION -->
	<target name="create.webapp">
		<echo>JPortal webapp</echo>
		<echo>Copy JPortal Stuff</echo>
		<copy todir="${build.webapps}" flatten="true" preservelastmodified="true">
			<fileset dir="${module.directory}/editor/form" includes="**/*.xml" />
			<fileset dir="${module.directory}/editor/error" includes="**/*.xml" />
			<fileset dir="${module.directory}/editor/restore" includes="**/*.xml" />
			<fileset dir="${module.directory}" includes="fileMappings.xml" />
		</copy>

		<copy todir="${build.webapps}/editor" flatten="true" preservelastmodified="true">
			<fileset dir="${module.directory}/editor/common" includes="**/*.xml" />
		</copy>

		<copy todir="${build.webapps}/WEB-INF/classes/" flatten="true" preservelastmodified="true">
			<fileset dir="${module.directory}/editor/acl" includes="**/*.xml" />
		</copy>
		
		<copy todir="${build.webapps}/WEB-INF/classes/" flatten="true" preservelastmodified="true">
			<fileset dir="${module.directory}/" includes="**/messages_*.properties" />
		</copy>

		<copy todir="${basedir}/config/solr-home">
			<fileset dir="${module.directory}/solr" />
		</copy>

		<unjar dest="${build.webapps}/WEB-INF/classes/xsl" overwrite="true">
			<fileset file="${module.jar}" />
			<patternset>
				<include name="xsl/**" />
			</patternset>
			<regexpmapper from="^(xsl/)(.*)" to="\2" />
		</unjar>

		<unjar dest="${build.webapps}/WEB-INF/classes/xml" overwrite="true">
			<fileset file="${module.jar}" />
			<patternset>
				<include name="xml/**" />
			</patternset>
			<regexpmapper from="^(xml/)(.*)" to="\2" />
		</unjar>

		<unjar dest="${build.webapps}" overwrite="true">
			<fileset file="${module.jar}" />
			<patternset>
				<include name="web/**" />
			</patternset>
			<regexpmapper from="^(web/)(.*)" to="\2" />
		</unjar>

	</target>

	 <target name="config">
	    <mcr:config action="addInclude"
	                propertyfile="${build.config}/mycore.properties"
	                key="MCR.CLI.Classes.Annotated"
	                value="org.mycore.frontend.cli.MigratingCMDs" />
	</target>
</project>
