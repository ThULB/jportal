<project name="webservices">
  <import file="../../integrate.xml" />
  <property name="wsadminurl" value="${MCR.baseurl}services/AdminService" />
  <property name="wsurl" value="${MCR.baseurl}services/MCRWebService" />

  <!-- - - - - - - - - - - - - - - - - - 
          target: config                      
         - - - - - - - - - - - - - - - - - -->
  <target name="config" description="copies deployment descriptors">
    <copy todir="${build.config}">
      <fileset dir="${basedir}/config" includes="*.wsdd" />
    </copy>
  </target>

  <!-- - - - - - - - - - - - - - - - - - 
          target: compile                      
         - - - - - - - - - - - - - - - - - -->
  <target name="compile" description="Build and compiles all webservice classes">
    <echo level="info">
			compiling ${ant.project.name}
    </echo>
    <antcall target="wsdl2java" />
    <mkdir dir="${build.classes}" />
    <javac destdir="${build.classes}" classpathref="integration.classpath" encoding="ISO-8859-1">
      <src path="${build.sources}/org/mycore/services/wsclient" />
    </javac>
  </target>

  <!-- - - - - - - - - - - - - - - - - - 
          target: wsdl2java                      
         - - - - - - - - - - - - - - - - - -->
  <target name="wsdl2java" depends="java2wsdl">
    <echo level="info">
      Building stubs from MCRWebService.wsdl
    </echo>
    <taskdef name="axis-wsdl2java"
             classname="org.apache.axis.tools.ant.wsdl.Wsdl2javaAntTask"
             classpathref="integration.classpath" />
    <mkdir dir="${build.sources}" />
    <unjar dest="${build.sources}" src="${mycore.jar}">
      <patternset>
        <include name="org/mycore/services/wsclient/**" />
      </patternset>
    </unjar>
    <!-- build java code -->
    <axis-wsdl2java all="true"
                    output="${build.sources}"
                    testcase="false"
                    verbose="true"
                    serverside="true"
                    url="${build.config}/MCRWebService.wsdl">
      <mapping namespace="${wsurl}" package="org.mycore.services.wsclient" />
    </axis-wsdl2java>
  </target>
  <!-- - - - - - - - - - - - - - - - - - 
          target: java2wsdl                      
         - - - - - - - - - - - - - - - - - -->
  <target name="java2wsdl">
    <echo level="info">
      Building wsdl from MCRWS.class
    </echo>
    <delete file="${build.config}/MCRWebService.wsdl" />
    <taskdef name="axis-java2wsdl"
             classname="org.apache.axis.tools.ant.wsdl.Java2WsdlAntTask"
             classpathref="integration.classpath" />
    <mkdir dir="${build.config}" />
    <axis-java2wsdl classname="org.mycore.services.webservices.MCRWS"
                    namespace="wsclient.services.mycore.org"
                    location="${wsurl}"
                    output="${build.config}/MCRWebService.wsdl"
                    style="RPC">
      <classpath refid="integration.classpath" />
      <mapping namespace="${wsurl}" package="org.mycore.services.wsclient" />
    </axis-java2wsdl>
  </target>
  <!-- - - - - - - - - - - - - - - - - - 
          target: create.scripts                      
         - - - - - - - - - - - - - - - - - -->
  <target name="create.scripts" depends="script.windows, script.unix" description="Create commandline scripts" />
  <!-- - - - - - - - - - - - - - - - - - 
          target: scripts.windows                      
         - - - - - - - - - - - - - - - - - -->
  <target name="script.windows"
          if="os.is.windows"
          description="Generates wsclient.cmd for starting wsclient from Command Line">
    <echo level="info">
      Generating wsclient.cmd for starting wsclient from Command Line
    </echo>

    <echo file="${build.bin}/wsclient.cmd">@echo off 
SET AXISCLASSPATH=${application.classpath.translated};%CLASSPATH% 
java -Xms128m -Xmx512m -classpath "%AXISCLASSPATH%" org.mycore.services.wsclient.MCRWebServiceClient %1 %2 %3 %4 %5 %6 %7 %8 %9
    </echo>
  </target>
  <!-- - - - - - - - - - - - - - - - - - 
          target: scripts.unix                      
         - - - - - - - - - - - - - - - - - -->
  <target name="script.unix"
          if="os.is.unix"
          description="Generates wsclient.sh for starting wsclient from Command Line">
    <echo level="info">
      Generating wsclient.sh for starting wsclient from Command Line
    </echo>

    <echo file="${build.bin}/wsclient.sh">#!/bin/sh
export AXISCLASSPATH=${application.classpath.translated}:$CLASSPATH
java -Xms128m -Xmx512m -classpath "${AXISCLASSPATH}" org.mycore.services.wsclient.MCRWebServiceClient "$@"
    </echo>
    <chmod file="${build.bin}/wsclient.sh" perm="755" />
  </target>

  <!-- - - - - - - - - - - - - - - - - - 
          target: deploy                      
         - - - - - - - - - - - - - - - - - -->
  <target name="webservice.deploy" description="deploys all webservices to a running axis admin servlet">
    <echo level="info">
			deploying ${ant.project.name}
    </echo>
    <antcall target="axis.admin">
      <param name="wsdd" value="deploy" />
    </antcall>
  </target>

  <!-- - - - - - - - - - - - - - - - - - 
          target: undeploy                      
         - - - - - - - - - - - - - - - - - -->
  <target name="webservice.undeploy" description="undeploys all webservices from a running axis admin servlet">
    <echo level="info">
			undeploying ${ant.project.name}
    </echo>
    <antcall target="axis.admin">
      <param name="wsdd" value="undeploy" />
    </antcall>
  </target>

  <!-- - - - - - - - - - - - - - - - - - 
          target: axis.admin                      
         - - - - - - - - - - - - - - - - - -->
  <target name="axis.admin">
    <fail unless="MCR.WebService.Admin" message="user for Axis admin is not set with property MCR.WebService.Admin" />
    <fail unless="MCR.WebService.AdminPasswd"
          message="password for user Axis admin is not set with property MCR.WebService.AdminPasswd" />
    <taskdef resource="axis-tasks.properties" classpathref="integration.classpath" />
    <axis-admin url="${wsadminurl}"
                failonerror="true"
                debug="true"
                xmlfile="${build.config}/${wsdd}.wsdd"
                username="${MCR.WebService.Admin}"
                password="${MCR.WebService.AdminPasswd}" />
  </target>

</project>