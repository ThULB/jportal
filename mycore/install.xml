<?xml version="1.0" encoding="ISO-8859-1"?>

<!-- =================================================================== -->
<!-- 
         A small installer tool for MyCoRe and DocPortal

         Downloads mycore, docportal and content/defaultsample
         Builds docportal and loads sample content 
         Starts webserver and downloads the DocPortal homepage
         $Revision: 1.7 $ $Date: 2007-12-13 10:19:30 $  
--> 
<!-- =================================================================== -->

<project name="DocPortalInstaller" default="install" basedir=".">
  <property name="destdir"     value="c:/java/install" />
  <property name="jai.libdir"  value="C:/Java/jai-1_1_2/lib" />
  <property name="mailserver"  value="mailout.uni-due.de" />
  <property name="mailaddress" value="luetzenkirchen@ub.uni-duisburg-essen.de" />

  <condition property="os.is.unix">
    <os family="unix" />
  </condition>
  <condition property="os.is.windows">
    <os family="dos" />
  </condition>

  <target name="install">
    <antcall target="download" />
    <antcall target="build" />
    <antcall target="stop" />
  </target>
  
  <target name="download" >
    <mkdir dir="${destdir}" />
    <echo>

    ========================================  
      SVN export from head ...
    ========================================  

    </echo>
    <antcall target="svn.checkout">
      <param name="srcUrl"   value="http://server.mycore.de/svn/mycore/trunk" />
      <param name="destPath" value="${destdir}/mycore" />
    </antcall>

    <antcall target="svn.export">
      <param name="srcUrl"   value="http://server.mycore.de/svn/docportal/trunk" />
      <param name="destPath" value="${destdir}/docportal" />
    </antcall>

    <antcall target="svn.export">
      <param name="srcUrl"   value="http://server.mycore.de/svn/content/trunk/defaultsample" />
      <param name="destPath" value="${destdir}/content/defaultsample" />
    </antcall>
  </target>
  
  <target name="build">
    <echo>

    ========================================  
      Build mycore.jar ...
    ========================================  

    </echo>
    <copy file="${destdir}/mycore/config/build.properties.template" tofile="${destdir}/mycore/config/build.properties" />
    <mkdir dir="${destdir}/mycore/build/lib" />
    <copy todir="${destdir}/mycore/lib" failonerror="false">
      <fileset dir="${jai.libdir}" includes="*.jar" />
    </copy>
    <ant dir="${destdir}/mycore" antfile="build.xml" target="jar" inheritAll="false" inheritRefs="false" />    
    <echo>

    ========================================  
      Edit mycore.properties.private ...
    ========================================  

    </echo>
    <copy file="${destdir}/docportal/config/mycore.properties.private.template" tofile="${destdir}/docportal/config/mycore.properties.private" />
    <replace file="${destdir}/docportal/config/mycore.properties.private" token="MCR.basedir=/home/mcradmin/docportal" value="MCR.basedir=${destdir}/docportal" />
    <replace file="${destdir}/docportal/config/mycore.properties.private" token="MCR.Mail.Server=my-mail-host.de" value="MCR.Mail.Server=${mailserver}" />
    <replace file="${destdir}/docportal/config/mycore.properties.private" token="MCR.Mail.Address=" value="MCR.Mail.Address=${mailaddress}" />
    <replace file="${destdir}/docportal/config/mycore.properties.private" token="MCR.WebService.Admin=" value="MCR.WebService.Admin=wsadmin" />
    <replace file="${destdir}/docportal/config/mycore.properties.private" token="MCR.WebService.AdminPasswd=" value="MCR.WebService.AdminPasswd=wspasswd" />
    <copy file="${destdir}/docportal/config/hibernate/hibernate.cfg.xml.template" tofile="${destdir}/docportal/config/hibernate/hibernate.cfg.xml" />
    <ant dir="${destdir}/docportal" antfile="build.xml" target="info"               inheritAll="false" inheritRefs="false" />    
    <echo>

    ========================================  
      Create directories ...
    ========================================  

    </echo>
    <ant dir="${destdir}/docportal" antfile="build.xml" target="create.directories" inheritAll="false" inheritRefs="false" />    
    <echo>

    ========================================  
      Create XML Schema files ...
    ========================================  

    </echo>
    <ant dir="${destdir}/docportal" antfile="build.xml" target="create.schema"      inheritAll="false" inheritRefs="false" />    
    <echo>

    ========================================  
      Build jar ...
    ========================================  

    </echo>
    <ant dir="${destdir}/docportal" antfile="build.xml" target="create.jar"         inheritAll="false" inheritRefs="false" />    
    <echo>

    ========================================  
      Create shell scripts ...
    ========================================  

    </echo>
    <ant dir="${destdir}/docportal" antfile="build.xml" target="create.scripts"     inheritAll="false" inheritRefs="false" />    
    <echo>

    ========================================  
      Start HSQLDB ...
    ========================================  

    </echo>
    <antcall target="run">
      <param name="command" value="hsqldbstart" />
    </antcall>
    <sleep seconds="30" />
    <echo>

    ========================================  
      Create users ...
    ========================================  

    </echo>
    <ant dir="${destdir}/docportal" antfile="build.xml" target="create.users"         inheritAll="false" inheritRefs="false" />    
    <echo>

    ========================================  
      Create default rules ...
    ========================================  

    </echo>
    <ant dir="${destdir}/docportal" antfile="build.xml" target="create.default-rules" inheritAll="false" inheritRefs="false" />    
    <echo>

    ========================================  
      Load classifications ...
    ========================================  

    </echo>
    <ant dir="${destdir}/docportal" antfile="build.xml" target="create.class"         inheritAll="false" inheritRefs="false" />    
    <echo>

    ========================================  
      Generate search masks ...
    ========================================  

    </echo>
    <ant dir="${destdir}/docportal" antfile="build.xml" target="create.searchmask"    inheritAll="false" inheritRefs="false" />    
    <echo>

    ========================================  
      Load default sample content ...
    ========================================  

    </echo>
    <ant dir="${destdir}/content/defaultsample" antfile="build.xml" target="load"     inheritAll="false" inheritRefs="false" />    
    <echo>

    ========================================  
      Build web application ...
    ========================================  

    </echo>
    <ant dir="${destdir}/docportal" antfile="build.xml" target="create.webapp"        inheritAll="false" inheritRefs="false" />    
    <echo>  

    ========================================  
      Start web application server ...
    ========================================  

    </echo>
    <antcall target="run">
      <param name="command" value="jettystart" />
    </antcall>
  </target>
  
  <target name="stop">
    <sleep seconds="30" />
    <echo>

    ========================================  
      Download DocPortal homepage ...
    ========================================  

    </echo>
    <get src="http://localhost:8291/content/below/index.xml" dest="${destdir}/homepage.html" verbose="on" />
    <echo>

    ========================================  
      Stop web application server ...
    ========================================  

    </echo>
    <antcall target="run">
      <param name="command" value="jettystop" />
    </antcall>
    <echo>

    ========================================  
      Stop HSQLDB ...
    ========================================  

    </echo>
    <antcall target="run">
      <param name="command" value="hsqldbstop" />
    </antcall>
    <echo>

    ========================================  
      Show HTML downloaded ...
    ========================================  

    </echo>
    <loadfile property="homepage" srcFile="${destdir}/homepage.html" />
    <echo>${homepage}</echo>
    <echo>

    ========================================  
      THE END ...
    ========================================  

    </echo>
  </target>
  
  <target name="run">
    <antcall target="run.windows">
      <param name="command" value="${command}" />
    </antcall>
    <antcall target="run.unix">
      <param name="command" value="${command}" />
    </antcall>
  </target>
  
  <target name="run.windows" if="os.is.windows">
    <exec executable="cmd" spawn="true">
      <arg value="/c"/>
      <arg value="${destdir}/docportal/build/bin/${command}.cmd"/>
      <arg value="-p"/>
    </exec>
  </target>
  
  <target name="run.unix" if="os.is.unix">
    <exec executable="nohup" spawn="true">
      <arg value="/bin/sh"/>
      <arg value="${destdir}/docportal/build/bin/${command}.sh"/>
    </exec>
  </target>
	
  <target name="svn.export">
    <exec executable="svn" spawn="false">
      <arg value="export"/>
      <arg value="--force"/>
      <arg value="${srcUrl}"/>
      <arg value="${destPath}"/>
    </exec>
  </target>

  <target name="svn.checkout">
    <exec executable="svn" spawn="false">
      <arg value="checkout"/>
      <arg value="${srcUrl}"/>
      <arg value="${destPath}"/>
    </exec>
  </target>

</project>
