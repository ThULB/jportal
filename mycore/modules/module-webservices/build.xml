<?xml version="1.0" encoding="UTF-8"?>

<!-- ============================================== -->
<!--      MyCoRe-WebService build file for use with ANT        -->
<!-- $Revision: 1.12 $ $Date: 2006/05/23 09:58:22 $ -->
<!-- ============================================== -->

<project name="MyCoReModule - WebService" default="usage" basedir=".">

    <!-- Read in environment variables -->
    <property environment="env" />
  
    <property file="${basedir}/../../config/mycore.properties.private" />

    <property name="wsadminurl"    value="${MCR.baseurl}services/AdminService" />
    <property name="wsurl"         value="${MCR.baseurl}services/MCRWebService" />
  
	<!-- ============================================== -->

	<property name="build.sysclasspath" value="last" />

	<!-- ============================================== -->

	<target name="version">
		<echo>
           Ant version: ${ant.version}
      Java JDK version: ${java.version} 
      Operating system: ${os.name}, version: ${os.version}, architecture: ${os.arch}
    </echo>
	</target>

	<!-- ============================================== -->

	<target name="usage">
		<echo>
      Use the ant tool to plug in MyCoRe-WeService-Module:
      Usage: ant [target] [target] [target] ...

      Available targets for MyCoRe-WebService are:
        compile            compiles the Java Sources
        webapps            copy files to webapps
        deploy             deploy webservices
        undeploy           undeploy webservices
        compile.ws         compile WebServices interface (MCRWS.java)
        java2wsdl          build MCRWebService.wsdl from MCRWS.class
        wsdl2java          generate stubs from MCRWebService.wsdl
        compile.client     compile webservice client and stubs
        wsclient.cmd       build wsclient command (Windows)
        wsclient.sh        build wsclient command (Linux/Unix)
        clean              delete directory build
		</echo>
	</target>
	
  <!-- =================================================================== -->
  <!-- Compiles the sources from directory sources to directory classes    -->
  <!-- =================================================================== -->

  <target name="init">
    <mkdir dir="${basedir}/classes" />
    <path id="mycore.classpath">
      <fileset dir="${basedir}/lib" includes="*.jar"/>
      <fileset dir="${basedir}/modules/module-webservices/lib" includes="*.jar"/>
    </path>
  </target>

  <target name="javac" depends="init" >
    <echo>Compiling ${packages}</echo>
    <javac srcdir="${basedir}/modules/module-webservices/sources"
           destdir="${basedir}/classes"
           includes="${packages}"
           excludes="org/mycore/services/wsclient/**"
           classpathref="mycore.classpath"
           debug="${debug}"
           optimize="${optimize}"
           target="${javatarget}"
           source="${sourcerelease}"
           encoding="${sourceencoding}"
           deprecation="${deprecation}">
    </javac>
  </target>

  <target name="compile">
   <echo>Compiling Module MyCoRe-WebServices classes...</echo>
   <antcall target="javac">
     <param name="packages" value="org/**"/>
   </antcall>
  </target>

  <!-- =================================================================== -->
  <target name="webapps">
    <echo>
      Copying web application files of module "WebServices"
    </echo>
    <property name="webapps-libdir" value="webapps/WEB-INF/lib"/>  	
  	<property name="modules-home" value="${env.MYCORE_HOME}" />
    <copy todir="${webapps-libdir}">
      <fileset dir="${modules-home}/modules/module-webservices/lib" includes="*.jar" />
    </copy>
  </target>

  <!-- ============================================== -->

  <target name="deploy" description="deploys all webservices to a running axis admin servlet">
    <antcall target="axis.admin">
      <param name="wsdd" value="deploy" />
    </antcall>
  </target>

  <!-- ============================================== -->
	
  <target name="undeploy" description="undeploys all webservices from a running axis admin servlet">
    <antcall target="axis.admin">
      <param name="wsdd" value="undeploy" />
    </antcall>
  </target>

  <!-- ============================================== -->
		
  <target name="axis.admin">
    <path id="deploy.classpath">
      <fileset dir="lib" includes="*.jar" />
      <fileset dir="${env.MYCORE_HOME}/lib" includes="*.jar" />
      <fileset dir="${env.MYCORE_HOME}/modules/module-webservices/lib" includes="*.jar" />
    </path>
    <taskdef resource="axis-tasks.properties" classpathref="deploy.classpath" />
    <axis-admin 
      url="${wsadminurl}"
      failonerror="true" 
      debug="true" 
      xmlfile="config/${wsdd}.wsdd" 
    />
  </target>

  <!-- ============================================== -->

  <target name="compile.ws">
    <echo>
      Compiling WebServices interface
    </echo>
    <mkdir dir="build/classes" />
    <javac destdir="build/classes" encoding="ISO-8859-1">
      <src path="sources/org/mycore/services/webservices" />
      <include name="**/MCRWS.java" /> 
    </javac>
  </target>
  
  <!-- ============================================== -->

  <target name="java2wsdl" depends="compile.ws">
    <echo>
      Building wsdl from MCRWS.class
    </echo>
    <delete file="build/MCRWebService.wsdl" />
    <path id="wsdl2java.classpath">
      <fileset dir="../../lib" includes="*.jar" />
      <fileset dir="lib" includes="*.jar" />
      <pathelement location="build/classes" />
    </path>
    <taskdef name="axis-java2wsdl" classname="org.apache.axis.tools.ant.wsdl.Java2WsdlAntTask" classpathref="wsdl2java.classpath" />	
    <axis-java2wsdl 
      classname="org.mycore.services.webservices.MCRWS"
      namespace="wsclient.services.mycore.org"
      location="${wsurl}" 
      output="build/MCRWebService.wsdl"
      style="RPC"
    >
      <classpath refid="wsdl2java.classpath" />       
      <mapping namespace="${wsurl}" package="org.mycore.services.wsclient" />
    </axis-java2wsdl>
  </target>
  
  <!-- ============================================== -->

  <target name="wsdl2java" depends="java2wsdl">
    <echo>
      Building stubs from build/MCRWebService.wsdl
    </echo>
    <path id="wsdl2java.classpath">
      <fileset dir="../../lib" includes="*.jar" />
      <fileset dir="lib" includes="*.jar"/>
    </path>
    <taskdef name="axis-wsdl2java" classname="org.apache.axis.tools.ant.wsdl.Wsdl2javaAntTask" classpathref="wsdl2java.classpath" />
    <delete dir="build/src" />
    <mkdir dir="build/src" />
    <axis-wsdl2java 
      all="true"
      output="build/src"
      testcase="false"
      verbose="true"
      serverside="true"
      url="build/MCRWebService.wsdl" 
    >
      <mapping namespace="${wsurl}" package="org.mycore.services.wsclient" /> 
    </axis-wsdl2java>
  </target>

  <!-- ============================================== -->

  <target name="compile.client" depends="wsdl2java">
    <echo>
      Compiling WebServices client
    </echo>
    <mkdir dir="build/classes" />
    <path id="axis.classpath">
      <fileset dir="../../lib" includes="*.jar" />
      <fileset dir="lib" includes="*.jar"/>
    </path>
    <javac destdir="build/classes" classpathref="axis.classpath" encoding="ISO-8859-1">
      <src path="build/src/org/mycore/services/wsclient" />
      <src path="sources/org/mycore/services/wsclient" />
    </javac>
  </target>
  
  <!-- ============================================== -->

    <target name="wsclient.cmd" depends="compile.client">
    <echo>

      Generating wsclient.cmd for starting wsclient from Command Line
    </echo>
    
    <mkdir dir="build/bin" />

    <echo file="build/bin/mycore.properties"/>
    
    <path id="wsclient.classpath">
      <fileset dir="../../lib" includes="*.jar" />
      <fileset dir="lib" includes="*.jar"/>
      <pathelement location="build/bin" />
      <pathelement location="build/classes" />
    </path>
    
    <copy todir="build/bin" preservelastmodified="yes">
      <fileset dir="config"        includes="client_deploy.wsdd" />
    </copy>
    
   <property name="path"           refid="wsclient.classpath"/>

    <echo file="build/bin/wsclient.cmd">@echo off 
SET AXISCLASSPATH=${path};%CLASSPATH% 
java -Xms128m -Xmx512m -classpath "%AXISCLASSPATH%" org.mycore.services.wsclient.MCRWebServiceClient %1 %2 %3 %4 %5 %6 %7 %8 %9
    </echo>
  </target>
  
    <target name="wsclient.sh" depends="compile.client" description="Generates wsclient.sh for starting wsclient from Command Line">
    <echo>

      Generating wsclient.sh for starting wsclient from Command Line
    </echo>
    
    <mkdir dir="build/bin" />

    <echo file="build/bin/mycore.properties"/>
    
    <path id="wsclient.classpath">
      <fileset dir="../../lib" includes="*.jar" />
      <fileset dir="lib" includes="*.jar"/>
      <pathelement location="build/bin" />
      <pathelement location="build/classes" />
    </path>
    
    <copy todir="build/bin" preservelastmodified="yes">
      <fileset dir="config"        includes="client_deploy.wsdd" />
    </copy>
    
   <property name="path"           refid="wsclient.classpath"/>

    <echo file="build/bin/wsclient.sh">#!/bin/sh
export AXISCLASSPATH=${path}:${CLASSPATH}
java -Xms128m -Xmx512m -classpath "${AXISCLASSPATH}" org.mycore.services.wsclient.MCRWebServiceClient $@
    </echo>
    <chmod file="build/bin/wsclient.sh" perm="755" />
  </target>
  
  <!-- ============================================== -->

    <target name="clean">
    <echo>
      Delete directory "build"
    </echo>
    
    <delete dir="build" />
  </target>
  
</project>


