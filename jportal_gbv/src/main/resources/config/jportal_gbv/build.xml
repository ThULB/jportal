<?xml version="1.0" encoding="UTF-8"?>
<project name="jportal_gbv" xmlns:mcr="antlib:org.mycore.buildtools">
  <import file="${basedir}/common-modules.xml"/>
  <import file="${basedir}/build.xml"/>

  <property name="module.directory" location="${ant.file}/.."/>
  <property file="${module.directory}/build.properties"/>
  <property name="module.jar" location="${build.lib}/${module.jar.name}"/>

  <property name="jportal.directory" location="${ant.file}/../../jportal_mcr"/>

  <target name="create.default-rules" description="loads default acl rules for archive application">
    <echo>JPortal: Default rules</echo>
    <antcall target="invoke.cli">
      <param name="cli.directory" value="${jportal.directory}/acl"/>
      <param name="cli.command" value="process defaultrules-commands"/>
    </antcall>
    <echo>JPortal: Web ACL</echo>
    <antcall target="invoke.cli">
      <param name="cli.directory" value="${jportal.directory}/acl"/>
      <param name="cli.command" value="process webacl-commands"/>
    </antcall>
  </target>

  <target name="create.users">
    <echo>JPortal: Create users and groups</echo>
    <antcall target="invoke.cli">
      <param name="cli.directory" value="${jportal.directory}/usersAndGroups"/>
      <param name="cli.command" value="process usersAndGroups-commands"/>
    </antcall>
  </target>

  <target name="config">
    <echo>JPortal: config</echo>
    <mcr:config action="addInclude"
                propertyfile="${build.config}/mycore.properties"
                key="MCR.CLI.Classes.Annotated"
                value="org.mycore.frontend.cli.MigratingCMDs"/>
  </target>

  <target name="create.webapp">
    <echo>JPortal-GBV create.webapp</echo>

    <copy todir="${build.webapps}" flatten="true" preservelastmodified="true">
      <fileset dir="${jportal.directory}/editor/form" includes="**/*.xml"/>
      <fileset dir="${jportal.directory}/editor/error" includes="**/*.xml"/>
      <fileset dir="${jportal.directory}/editor/restore" includes="**/*.xml"/>
      <fileset dir="${jportal.directory}" includes="fileMappings.xml"/>
    </copy>

    <copy todir="${build.webapps}/editor" flatten="true" preservelastmodified="true">
      <fileset dir="${jportal.directory}/editor/common" includes="**/*.xml"/>
    </copy>

    <copy todir="${build.webapps}/WEB-INF/classes/" flatten="true" preservelastmodified="true">
      <fileset dir="${jportal.directory}/editor/acl" includes="**/*.xml"/>
    </copy>

    <copy todir="${build.webapps}/WEB-INF/classes/" flatten="true" preservelastmodified="true">
      <fileset dir="${jportal.directory}/" includes="**/messages_*.properties"/>
    </copy>

    <copy todir="${basedir}/config/solr-home">
      <fileset dir="${jportal.directory}/solr"/>
    </copy>

    <echo>Unjar xsl to ${build.webapps}/WEB-INF/classes/xsl from ${module.jar}</echo>
    <unjar dest="${build.webapps}/WEB-INF/classes/xsl" overwrite="true">
      <fileset file="${module.jar}"/>
      <patternset>
        <include name="xsl/**"/>
      </patternset>
      <regexpmapper from="^(xsl/)(.*)" to="\2"/>
    </unjar>

    <unjar dest="${build.webapps}/WEB-INF/classes/xml" overwrite="true">
      <fileset file="${module.jar}"/>
      <patternset>
        <include name="xml/**"/>
      </patternset>
      <regexpmapper from="^(xml/)(.*)" to="\2"/>
    </unjar>

    <unjar dest="${build.webapps}" overwrite="true">
      <fileset file="${module.jar}"/>
      <patternset>
        <include name="web/**"/>
      </patternset>
      <regexpmapper from="^(web/)(.*)" to="\2"/>
    </unjar>


    <echo>Merging JPortal-GBV properties</echo>
    <mcr:config propertyfile="${build.config}/mycore.properties" mergeFile="${module.directory}/mycore.properties"/>
    <mcr:config propertyfile="${build.webapps}/WEB-INF/classes/mycore.properties"
                mergeFile="${module.directory}/mycore.properties"/>

  </target>


</project>
