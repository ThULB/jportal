<?xml version="1.0" encoding="UTF-8"?>

<!-- =================================================================== -->
<!-- MyCoRe - Module-Broadcasting build file for use with ANT            -->
<!--  												                     -->
<!-- Andreas Trappe 	- idea, concept, dev.		                     -->
<!--												                     -->
<!-- =================================================================== -->

<project name="MyCoReModule - Broadcasting"  basedir="../..">
	
    <property name="build.sysclasspath" value="last" />
    <import file="${basedir}/common-modules.xml" />
	<property name="module.base" value="broadcasting" />
	<property name="module.dir" value="${basedir}/modules/${module.base}" />

	<!-- =================================================================== -->
	<!-- Help on usage                                                       -->
	<!-- =================================================================== -->

	<target name="usage">
		<echo level="info">

      Available targets are:
		create.users         --> Add the module dependence user
		create.default-rules --> Add the module dependence rules
        webapps              --> Build the web application directory
        webapps.i18n         --> Build the messages_[lang].properties

      Please do not use any of the other targets, they are internal.
		</echo>
	</target>
	
	<!-- =================================================================== -->
	<!-- Info                                                                -->
	<!-- =================================================================== -->

	<target name="info">
		<echo>${ant.project.name} will include programs to use a brodcasting system online.</echo>
	</target>
	
	<!-- =================================================================== -->

	<target name="create.users" description="Load admin group for Module-Broadcasting">
        <echo level="info">
			building ${ant.project.name} create.users
	    </echo>

		<property name="commands.file" value="${basedir}/commands.txt"/>
		<echo file="${commands.file}" append="false">
        change to user ${MCR.Users.Superuser.UserName} with ${MCR.Users.Superuser.UserPasswd}
        create group data from file broadcastinggroup.xml
        add user ${MCR.Users.Superuser.UserName} as member to group broadcastinggroup    	
        check user data consistency
		</echo>
		<antcall target="invoke.cli">
			<param name="cli.directory" value="${basedir}/modules/broadcasting/config/access"  />
			<param name="cli.command"   value="process ${commands.file}" />
		</antcall>
		<delete file="${commands.file}" />
	</target>	

	<!-- =================================================================== -->	
	
	<target name="create.default-rules" description="Load default ACL rules for Module-Broadcasting">
        <echo level="info">
			building ${ant.project.name} create.default-rules
	    </echo>
  	
		<property name="commands.file" value="${basedir}/commands.txt"/>
		<echo file="${commands.file}" append="false">
    	update permission manage for id module-broadcasting with rulefile grant-broadcastinggroup.xml described by members of broadcastinggroup    	
    	update permission read for id webpage:/servlets/MCRBroadcastingServlet?mode=getReceiverList with rulefile grant-broadcastinggroup.xml described by members of broadcastinggroup    	    	
		</echo>
		<antcall target="invoke.cli">
			<param name="cli.directory" value="${basedir}/modules/broadcasting/config/access"  />
			<param name="cli.command"   value="process ${commands.file}" />
		</antcall>
		<delete file="${commands.file}" />
	</target>

	<!-- =================================================================== -->	
	
    <target name="webapps" >
        <echo level="info">
			building ${ant.project.name} webapp
	    </echo>
    	
		<!-- merge web.xml -->
        <available property="web.xml.present" file="${env.MYCORE_HOME}/modules/broadcasting/config/web.xml" />
        <antcall target="do.merge">
            <param name="web.xml.file" value="${env.MYCORE_HOME}/modules/broadcasting/config/web.xml" />
        </antcall>

    	<!-- copy config -->
        <mkdir dir="${build.webapps}/modules/broadcasting/config" />    	
        <copy todir="${build.webapps}/modules/broadcasting/config" flatten="false">
            <fileset file="${env.MYCORE_HOME}/modules/broadcasting/config/mcr-module-broadcasting.xml" />
        </copy>    	    	
    	
        <!-- copy Stylesheets -->
        <copy todir="${build.webapps}/WEB-INF/stylesheets/" preservelastmodified="yes" flatten="false">
            <fileset dir="${env.MYCORE_HOME}/modules/broadcasting/xsl">
                <include name="**/*.xsl" />
            </fileset>
        </copy>

    	<!-- copy web stuff -->
        <mkdir dir="${build.webapps}/modules/broadcasting/web" />
        <copy todir="${build.webapps}/modules/broadcasting/web/" flatten="false">
            <fileset dir="${env.MYCORE_HOME}/modules/broadcasting/web" />
        </copy>

    </target>
    	
    <target name="webapps.i18n" >
        <echo level="info">
			building ${ant.project.name} webapp.i18n
	    </echo>
    	
		<!-- merge I18N files -->
		<antcall target="properties.merge">
			<param name="module" value="${mycore}/modules/broadcasting/config/messages_broadcasting_de.properties"/>
			<param name="locale_param" value="de"/>
		</antcall>			
		<antcall target="properties.merge">
			<param name="module" value="${mycore}/modules/broadcasting/config/messages_broadcasting_en.properties"/>
			<param name="locale_param" value="en"/>
		</antcall>

    </target>

   	<!-- =================================================================== -->		
	
</project>
