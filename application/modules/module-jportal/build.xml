<?xml version="1.0" encoding="ISO-8859-1"?>

<project name="MyCoReModule - JPortal" default="usage" basedir="../..">

	<property name="build.sysclasspath" value="last" />
	<import file="${basedir}/common-modules.xml" />

	<property name="env.MYJPORTAL_HOME" value="${basedir}/../myjportal" />
	<property name="env.JPORTAL_HOME" value="${basedir}/modules/module-jportal" />

	<!-- ============================================== -->
	<target name="usage">
		<echo>
          Usage:
            ant [target]

          All targets are internal, use $Docportal/jportal-build.xml

        </echo>
	</target>
	<!-- ============================================== -->

	<target name="webapps">
		<echo>
			building JPortal-Module webapp
	    </echo>

		<copy todir="${build.webapps}/WEB-INF/classes/">
			<fileset dir="${basedir}/config" includes="mycore.properties.jp" />
		</copy>

		<!-- merge the web.xml of the module to the application -->
		<available property="web.xml.present" file="${env.JPORTAL_HOME}/config/web.xml" />
		<antcall target="do.merge">
			<param name="web.xml.file" value="${env.JPORTAL_HOME}/config/web.xml" />
		</antcall>

		<!-- get JPORTAL sources -->
		<!-- ############################# -->
		<!-- get editors -->
		<copy todir="${build.webapps}/editor/">
			<fileset dir="${env.JPORTAL_HOME}/config" includes="editor-*.xml" />
			<fileset dir="${env.JPORTAL_HOME}/config" includes="imports-*.xml" />
		</copy>
		<antcall target="jp.webapps.copyWebPages">
			<param name="sourcedir.webpages" value="${env.JPORTAL_HOME}/webpages" />
		</antcall>
		<antcall target="jp.webapps.copyXSL">
			<param name="sourcedir.XSL" value="${env.JPORTAL_HOME}/stylesheets" />
		</antcall>

		<!-- get MYJPORTAL sources -->
		<!-- ############################# -->
		<!-- webpages stuff to "webapps" -->
		<antcall target="jp.webapps.copyWebPages">
			<param name="sourcedir.webpages" value="${env.MYJPORTAL_HOME}/webpages" />
		</antcall>
		<antcall target="jp.webapps.copyXSL">
			<param name="sourcedir.XSL" value="${env.MYJPORTAL_HOME}/stylesheets" />
		</antcall>
		<!-- copy templates  -->
		<!-- copy to application/webpages/... to ensure registering in chooseTemplate.xsl -->
		<copy todir="${basedir}/webpages/templates/master" failonerror="false">
			<fileset dir="${env.MYJPORTAL_HOME}/webpages/templates/master/" />
		</copy>
		<!-- copy to deployed folder -->
		<antcall target="jp.webapps.copyXSL">
			<param name="sourcedir.XSL" value="${env.MYJPORTAL_HOME}/webpages/templates/master" />
		</antcall>
		<!-- register dynamic layout templates in 'template_DynamicLayoutTemplates.xsl' 
        <antcall target="jp.webapps.dynamicLayoutTemplates" />
		-->
		
		
		<!-- config file -->
		<copy todir="${build.webapps}/WEB-INF/classes/">
			<fileset dir="${env.MYJPORTAL_HOME}/modules/module-jportal/config/" includes="mycore.properties.myjp" />
		</copy>

		<!-- i18n -->
		<antcall target="properties.merge">
			<param name="module" value="${env.DOCPORTAL_HOME}/modules/module-jportal/config/messages_de.properties" />
			<param name="locale_param" value="de" />
		</antcall>

		<antcall target="properties.merge">
			<param name="module" value="${env.DOCPORTAL_HOME}/modules/module-jportal/config/messages_en.properties" />
			<param name="locale_param" value="en" />
		</antcall>
	</target>

	<!-- =================================================================== -->

	<!-- create a new template_DynamicLayoutTemplates.xsl -->
	<target name="jp.webapps.dynamicLayoutTemplates">
		<taskdef name="templatecheck" classname="org.mycore.common.MCRDynamicLayoutTemplatesTask" classpathref="docportal.classpath" />
		<templatecheck choosepath="${build.webapps}/WEB-INF/stylesheets/template_DynamicLayoutTemplates.xsl" />
	</target>

	<!-- =================================================================== -->

	<target name="jp.webapps.copyWebPages">
		<!-- webpages stuff to "webapps" -->
		<copy todir="${build.webapps}" failonerror="false">
			<fileset dir="${sourcedir.webpages}" excludes="**/*.xsl" />
		</copy>
	</target>
	<!-- =================================================================== -->

	<target name="jp.webapps.copyXSL">
		<copy todir="${build.webapps}/WEB-INF/stylesheets" flatten="true" failonerror="false">
			<fileset dir="${sourcedir.XSL}" includes="**/*.xsl" />
		</copy>
	</target>
	<!-- =================================================================== -->

	<target name="compile">
		<echo>Compiling JPortal classes...</echo>
		<antcall target="javac">
			<param name="packages" value="org/mycore/**" />
		</antcall>
	</target>
	<!-- =================================================================== -->
	<target name="javac" depends="init">
		<echo>Compiling ${packages}</echo>
		<javac srcdir="${basedir}/modules/module-jportal/sources" destdir="${build.classes}" includes="${packages}" classpathref="mycore.classpath" debug="${debug}" optimize="${optimize}" target="${javatarget}" source="${sourcerelease}" encoding="${sourceencoding}" deprecation="${deprecation}">
		</javac>
	</target>
	<!-- =================================================================== -->
	<target name="init">
		<mkdir dir="${basedir}/classes" />
		<path id="mycore.classpath">
			<fileset dir="${basedir}/lib" includes="*.jar" />
			<fileset dir="${env.MYCORE_HOME}/lib" includes="*.jar" />
		</path>
	</target>

	<!-- =================================================================== -->

</project>