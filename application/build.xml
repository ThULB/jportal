<?xml version="1.0" encoding="UTF-8"?>

<!-- =================================================================== -->
<!-- MyCoRe sample application build file for use with Apache Ant        -->
<!-- $Revision: 1.149 $ $Date: 2006/12/11 13:48:51 $                      -->
<!-- =================================================================== -->

<project name="DocPortal" default="usage" basedir=".">
	
	<import file="${basedir}/common-modules.xml" />

  <!-- =================================================================== -->
  <!-- Help on usage                                                       -->
  <!-- =================================================================== -->

  <target name="usage" description="Display main targets by running 'ant -projecthelp'">
    <java classname="org.apache.tools.ant.Main" fork="false">
      <arg value="-projecthelp" />
    </java>
  </target>

  <!-- =================================================================== -->
  <!-- Output environment variables, software and operating system version -->
  <!-- =================================================================== -->

  <target name="info" depends="show" description="Shows Java/Ant/Operating System version, CLASSPATH etc." />

  <target name="show" depends="init">
    <echo level="info">Base directory     : ${basedir}</echo>
    <echo level="info">MyCoRe home dir    : ${env.MYCORE_HOME}</echo>
    <echo level="info">DocPortal home dir : ${env.DOCPORTAL_HOME}</echo>
    <echo level="info">Operating system   : ${os.name} Version ${os.version} on ${os.arch} </echo>
    <echo level="info">Java version       : JDK ${ant.java.version} Version ${java.version} from ${java.vendor}</echo>
    <echo level="info">Java home          : ${env.JAVA_HOME}</echo>
    <echo level="info">Ant build file     : $Revision: 1.149 $ $Date: 2006/12/11 13:48:51 $</echo>
    <echo level="info">Ant version        : ${ant.version}</echo>
    <echo level="info">XML Store type     : ${MCR.XMLStore.Type}</echo>
    <echo level="info">JDBC Store type    : ${MCR.JDBCStore.Type}</echo>
    <echo level="info">System CLASSPATH   : ${build.sysclasspath}</echo>
    <echo level="info">Active CLASSPATH   : ${docportal.classpath.translated}</echo>
    <echo level="info">Active LIBPATH     : ${docportal.libpath.translated}</echo>
  </target>


  <!-- =================================================================== -->
  <!-- Create all XML schema files from the configuration file             -->
  <!-- =================================================================== -->

  <target name="create.schema" depends="init" description="Generates all schema files from the configuration files">

    <!-- copy the stylesheets from MyCoRe -->
    <copy todir="${build.stylesheets}" file="${mycore.stylesheets}/MCRMetadataCoreTemplates.xsl" />
    <copy todir="${build.stylesheets}" file="${mycore.stylesheets}/MCRMetadataCoreTypes.xsl" />
    <copy todir="${build.stylesheets}" file="${mycore.stylesheets}/MCRMetadataSchema.xsl" />
    <copy todir="${build.stylesheets}" file="${mycore.stylesheets}/MCRMetadataTemplates.xsl" />
    <copy todir="${build.stylesheets}" file="${mycore.stylesheets}/MCRMetadataTypes.xsl" />
    <copy todir="${build.stylesheets}" file="${docportal.stylesheets}/MCRMetadataTemplates.xsl" overwrite="true" failonerror="false" />
    <copy todir="${build.stylesheets}" file="${docportal.stylesheets}/MCRMetadataTypes.xsl" overwrite="true" failonerror="false" />

    <!-- Load the properties that define the XML metadata configuration files -->
    <loadproperties srcFile="${basedir}/config/mycore.properties">
      <filterchain>
        <linecontains>
          <contains value="MCR.persistence_config_"/>
        </linecontains>
      </filterchain>
    </loadproperties>

    <!-- Translate *.xml to *.xsd using MCRMetadataSchema.xsl -->
    <antcall target="do.transform"><param name="metadata.schema" value="${MCR.persistence_config_document}" /></antcall>
    <antcall target="do.transform"><param name="metadata.schema" value="${MCR.persistence_config_derivate}" /></antcall>
    <antcall target="do.transform"><param name="metadata.schema" value="${MCR.persistence_config_author}" /></antcall>
    <antcall target="do.transform"><param name="metadata.schema" value="${MCR.persistence_config_institution}" /></antcall>

    <move todir="${build.schema}">
      <fileset dir="${build.schema}" 
        includes="${MCR.persistence_config_document} ${MCR.persistence_config_derivate} ${MCR.persistence_config_author} ${MCR.persistence_config_institution}"
      />
      <mapper type="glob" from="*.xml" to="*.xsd"/>
    </move>
  </target>

  <target name="do.transform" depends="init">
    <echo level="info">Transforming ${metadata.schema}...</echo>
    <xslt basedir="${docportal.config}"
          classpathref="docportal.classpath"
          in="${docportal.config}/${metadata.schema}"
          style="${build.stylesheets}/MCRMetadataSchema.xsl"
          out="${build.schema}/${metadata.schema}" />
  </target>

  <!-- =================================================================== -->
  <!-- Create scripts in bin like mycore.cmd/.sh a.s.o.                    -->
  <!-- =================================================================== -->

  <target name="create.scripts" depends="init, script.copy, script.windows, script.unix, scripts.modules" description="Create commandline scripts" >
    <chmod perm="755" >
      <fileset dir="${build.bin}" includes="*.sh" />
    </chmod>
  </target>

  <target name="scripts.modules">
    <echo level="info">
      do 'create.scripts' in all modules...
    </echo>
    <subant target="create.scripts" inheritall="true" inheritrefs="true">
      <fileset dir="${basedir}" includes="modules/module-*/build.xml" excludes="modules/module-webservices/build.xml">
      	<containsregexp expression="\u003ctarget.*name=\u0022create.scripts\u0022"/> 
      </fileset>
    </subant>
  </target>
	
  <target name="script.copy">
    <mkdir dir="${build.bin}" />
    <copy todir="${build.config}" overwrite="true">
      <fileset dir="${docportal.config}" includes="ContentStoreSelectionRules.xml"/>
      <fileset dir="${docportal.config}" includes="FileContentTypes.xml"/>
      <fileset dir="${docportal.config}" includes="mycore.properties"/>
      <fileset dir="${docportal.config}" includes="mycore.properties.application"/>
      <fileset dir="${docportal.config}" includes="mycore.properties.iview"/>
      <fileset dir="${docportal.config}" includes="searchfields.xml"/>
      <fileset dir="${docportal.config}" includes="mycore.properties.private"/>
      <fileset dir="${docportal.config}" includes="MCRRESUMPTIONTOKEN.hbm.xml"/>
    </copy>	  
    <mkdir dir="${build.lib}/jetty"/>
    <mkdir dir="${docportal.lib}/jetty/logs" />
    <copy todir="${build.lib}/jetty">
      <fileset dir="${docportal.lib}/jetty"/>
    </copy>	  
    <copy todir="${build.stylesheets}">
      <fileset dir="${docportal.stylesheets}" includes="mcr_save-derivate.xsl"/>
      <fileset dir="${docportal.stylesheets}" includes="mcr_save-object.xsl"/>
    </copy>	  
  </target>

  <target name="script.windows" if="os.is.windows">
    <!-- build commandline tool -->
    <antcall target="script.windows.write">
      <param name="mycore.cmd.file"  value="mycore.cmd" />
      <param name="mycore.cmd.class" value="org.mycore.frontend.cli.MCRCommandLineInterface %1 %2 %3 %4 %5 %6 %7 %8 %9" />
      <param name="mycore.cmd.dir" value="${build.bin}"/>
    </antcall>
    <antcall target="script.windows.write">
      <param name="mycore.cmd.file" value="listPlugins.cmd"/>
      <param name="mycore.cmd.class" value="org.mycore.sample.PluginLister $*"/>
      <param name="mycore.cmd.dir" value="${build.bin}"/>
    </antcall>
    <!-- build jetty scripts -->  	
    <pathconvert targetos="windows" property="jetty.home">
      <path><pathelement location="${build.lib}/jetty"/></path>
    </pathconvert>
    <antcall target="script.windows.write">
      <param name="mycore.cmd.file"  value="jettystart.cmd"/>
      <param name="mycore.cmd.class" value="-Djetty.home=${jetty.home} -Djetty.class.path=${jetty.home} -Djetty.port=8291 -jar ${jetty.home}\start.jar ${jetty.home}\webapp.xml"/>
      <param name="mycore.cmd.dir"   value="${build.bin}"/>
    </antcall>
    <antcall target="script.windows.write">
      <param name="mycore.cmd.file"  value="jettystop.cmd"/>
      <param name="mycore.cmd.class" value="-Djetty.home=${jetty.home} -Djetty.class.path=${jetty.home} -Djetty.port=8291 -jar ${jetty.home}\stop.jar"/>
      <param name="mycore.cmd.dir"   value="${build.bin}"/>
    </antcall>
    <!-- copy static command scripts -->
    <!-- build HSQLDB scripts (if it is configured) -->
    <pathconvert targetos="windows" property="hsqldb.datadir">
      <path><pathelement location="${MCR.persistence_sql_data_directory}/${MCR.persistence_sql_database_name}"/></path>
    </pathconvert>
    <antcall target="script.windows.server" />
  </target>

  <target name="script.windows.server" if="MCR.persistence_sql_data_directory">
    <mkdir dir="${MCR.persistence_sql_data_directory}" />
    <loadproperties srcFile="${docportal.config}/mycore.properties.private">
      <filterchain>
        <linecontains>
          <contains value="MCR.persistence_sql_database_port=" />
        </linecontains>
      </filterchain>
    </loadproperties>
    <loadproperties srcFile="${docportal.config}/mycore.properties.private">
      <filterchain>
        <tokenfilter>
          <replacestring from="%MCR.persistence_sql_database_port%" to="${MCR.persistence_sql_database_port}" />
        </tokenfilter>
      </filterchain>
    </loadproperties>
    <antcall target="script.windows.write">
      <param name="mycore.cmd.file"  value="hsqldbstart.cmd"/>
      <param name="mycore.cmd.class" value="org.hsqldb.Server -database ${hsqldb.datadir} -port ${MCR.persistence_sql_database_port}"/>
      <param name="mycore.cmd.dir"   value="${MCR.persistence_sql_data_directory}"/>
    </antcall>
    <antcall target="script.windows.write">
      <param name="mycore.cmd.file"  value="hsqldbstop.cmd"/>
      <param name="mycore.cmd.class" value="org.hsqldb.util.ShutdownServer -url ${MCR.persistence_sql_database_url}"/>
      <param name="mycore.cmd.dir"   value="${MCR.persistence_sql_data_directory}"/>
    </antcall>
    <antcall target="script.windows.write">
      <param name="mycore.cmd.file"  value="hsqldbadmin.cmd" />
      <param name="mycore.cmd.class" value="org.hsqldb.util.DatabaseManagerSwing $*" />
      <param name="mycore.cmd.dir" value="${build.bin}"/>
    </antcall>
  </target>

  <target name="script.unix" if="os.is.unix">
    <!-- build commandline tool -->
    <antcall target="script.unix.write">
      <param name="mycore.cmd.file" value="mycore.sh"/>
      <param name="mycore.cmd.class" value="org.mycore.frontend.cli.MCRCommandLineInterface $*"/>
      <param name="mycore.cmd.dir" value="${build.bin}"/>
    </antcall>
    <antcall target="script.unix.write">
      <param name="mycore.cmd.file" value="listPlugins.sh"/>
      <param name="mycore.cmd.class" value="org.mycore.sample.PluginLister $*"/>
      <param name="mycore.cmd.dir" value="${build.bin}"/>
    </antcall>
    <!-- build jetty scripts -->  	
    <antcall target="script.unix.write">
      <param name="mycore.cmd.file" value="jettystart.sh"/>
      <param name="mycore.cmd.class" value="-Djetty.home=${build.lib}/jetty -Djetty.class.path=${build.lib}/jetty -Djetty.port=8291 -jar ${build.lib}/jetty/start.jar ${build.lib}/jetty/webapp.xml"/>
      <param name="mycore.cmd.dir" value="${build.bin}"/>
    </antcall>
    <antcall target="script.unix.write">
      <param name="mycore.cmd.file" value="jettystop.sh"/>
      <param name="mycore.cmd.class" value="-Djetty.home=${build.lib}/jetty -Djetty.class.path=${build.lib}/jetty -Djetty.port=8291 -jar ${build.lib}/jetty/stop.jar"/>
      <param name="mycore.cmd.dir" value="${build.bin}"/>
    </antcall>
    <!-- copy static command scripts -->
    <copy todir="${build.bin}">
      <fileset dir="${docportal.bin}" includes="Save*.sh"/>
      <fileset dir="${docportal.bin}" includes="SQL*.sh"/>
      <fileset dir="${docportal.bin}" includes="sqltool.rc"/>
      <fileset dir="${docportal.bin}" includes="RepairIndex.sh"/>
      <fileset dir="${docportal.unixtools}" includes="*.sh"/>
    </copy>	  
    <!-- build HSQLDB scripts (if it is configured) -->
    <pathconvert targetos="unix" property="hsqldb.datadir">
      <path><pathelement location="${MCR.persistence_sql_data_directory}/${MCR.persistence_sql_database_name}"/></path>
    </pathconvert>
    <antcall target="script.unix.server" />
    <chmod perm="755" >
      <fileset dir="${build.bin}" includes="*.sh" />
	</chmod>
  </target>

  <target name="script.unix.server" if="MCR.persistence_sql_data_directory">
    <mkdir dir="${MCR.persistence_sql_data_directory}" />
    <loadproperties srcFile="${docportal.config}/mycore.properties.private">
      <filterchain>
        <linecontains>
          <contains value="MCR.persistence_sql_database_port=" />
        </linecontains>
      </filterchain>
    </loadproperties>
    <loadproperties srcFile="${docportal.config}/mycore.properties.private">
      <filterchain>
        <linecontains>
          <contains value="MCR.persistence_sql_database_url=" />
        </linecontains>
        <tokenfilter>
          <replacestring from="%MCR.persistence_sql_database_port%" to="${MCR.persistence_sql_database_port}" />
        </tokenfilter>
      </filterchain>
    </loadproperties>
    <antcall target="script.unix.write">
      <param name="mycore.cmd.file" value="hsqldbstart.sh"/>
      <param name="mycore.cmd.class" value="org.hsqldb.Server -database ${MCR.persistence_sql_data_directory}/${MCR.persistence_sql_database_name} -port ${MCR.persistence_sql_database_port}"/>
      <param name="mycore.cmd.dir" value="${MCR.persistence_sql_data_directory}"/>
    </antcall>
    <antcall target="script.unix.write">
      <param name="mycore.cmd.file" value="hsqldbstop.sh"/>
      <param name="mycore.cmd.class" value="org.hsqldb.util.ShutdownServer -url ${MCR.persistence_sql_database_url}"/>
      <param name="mycore.cmd.dir" value="${MCR.persistence_sql_data_directory}"/>
    </antcall>
    <antcall target="script.unix.write">
      <param name="mycore.cmd.file" value="hsqldbadmin.sh"/>
      <param name="mycore.cmd.class" value="org.hsqldb.util.DatabaseManagerSwing $*"/>
      <param name="mycore.cmd.dir" value="."/>
    </antcall>
  </target>

  <target name="script.windows.write">
    <property name="tmp.cmd.file" value="${build.bin}/${mycore.cmd.file}" />
    <echo level="info">Creating ${mycore.cmd.file} to invoke ${mycore.cmd.class}</echo>
    <echo file="${tmp.cmd.file}" append="false">@echo off

rem
rem This batch file invokes the MyCoRe class
rem ${mycore.cmd.class}
rem Generated by ant using the target "scripts".
rem

set CLASSPATH=${docportal.classpath.translated}

java -Xmx${java.maxmemory} ${mycore.cmd.class}
    </echo>
  </target>

  <target name="script.unix.write">
    <property name="tmp.cmd.file" value="${build.bin}/${mycore.cmd.file}" />
    <echo level="info">Creating ${mycore.cmd.file} to invoke ${mycore.cmd.class}</echo>
    <echo file="${tmp.cmd.file}" append="false">#!/bin/sh

#
# This shell script invokes the MyCoRe class
# ${mycore.cmd.class}
# Generated by ant using the target "scripts".
#

CLASSPATH=${docportal.classpath.translated}
export CLASSPATH

$JAVA_HOME/bin/java -Xmx${java.maxmemory} ${mycore.cmd.class}
    </echo>
    <chmod file="${tmp.cmd.file}" perm="755" />
  </target>

  <!-- =================================================================== -->
  <!-- Invokes the MyCoRe Command Line Interface with a given command      -->
  <!-- =================================================================== -->

  <target name="invoke.cli" depends="init">
    <java classname="org.mycore.frontend.cli.MCRCommandLineInterface"
          dir="${cli.directory}" fork="yes" maxmemory="${java.maxmemory}"
          classpathref="docportal.classpath" failonerror="true">
      <arg line="${cli.command}" />
      <env key="LIBPATH"         value="${env.LIBPATH}" />
      <env key="LD_LIBRARY_PATH" value="${env.LD_LIBRARY_PATH}" />
    </java>
  </target>

  <!-- =================================================================== -->
  <!-- Build an IzPack distribution                                        -->
  <!-- =================================================================== -->

  <target name="izpack" depends="init,copy.mycore,izpack.prebuild,izpack.build,izpack.postbuild,delete.mycore" />

  <target name="copy.mycore">
    <!-- mycore jars -->
    <mkdir dir="${docportal.mcrlib}" />
    <copy todir="${docportal.mcrlib}" preservelastmodified="true" >
      <fileset dir="${mycore.lib}" includes="*.jar" />
      <fileset dir="${mycore.lib}" includes="*License*.txt" />
      <fileset dir="${mycore.modules}/module-webservices/lib" includes="*.jar" />
      <fileset dir="${mycore.modules}/module-webservices/lib" includes="*License*.txt" />
      <fileset dir="${mycore.modules}/module-wcms/aif/lib" includes="*.jar" />
    </copy>
    <!-- mycore config -->
    <copy todir="${docportal.config}" preservelastmodified="true" file="${mycore.config}/build.properties" />
    <!-- mycore documentation -->
    <copy todir="${docportal.doc}" preservelastmodified="true" >
      <fileset dir="${mycore.doc}/Overview" includes="Overview.pdf" />
      <fileset dir="${mycore.doc}/UserGuide" includes="UserGuide.pdf" />
      <fileset dir="${mycore.doc}/ProgGuide" includes="ProgrammerGuide.pdf" />
    </copy>
    <mkdir dir="${docportal.doc}/html" />
    <copy todir="${docportal.doc}/html" >
      <fileset dir="${mycore.doc}/html" includes="**/*" />
    </copy>
  </target>

  <target name="izpack.prebuild" depends="izpack.prebuild.unix,izpack.prebuild.windows"/>

  <target name="izpack.prebuild.unix">
    <!-- replace in bin -->
    <replace file="${docportal.bin}/hsqldbadmin.sh" token="${MCR.basedir}" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/hsqldbadmin.sh" token="${env.MYCORE_HOME}/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/hsqldbadmin.sh" token="${env.MYCORE_HOME}/modules/module-webservices/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/hsqldbstart.sh" token="${MCR.basedir}" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/hsqldbstart.sh" token="${env.MYCORE_HOME}/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/hsqldbstart.sh" token="${env.MYCORE_HOME}/modules/module-webservices/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/hsqldbstop.sh" token="${MCR.basedir}" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/hsqldbstop.sh" token="${env.MYCORE_HOME}/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/hsqldbstop.sh" token="${env.MYCORE_HOME}/modules/module-webservices/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/jettystart.sh" token="${MCR.basedir}" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/jettystart.sh" token="${env.MYCORE_HOME}/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/jettystart.sh" token="${env.MYCORE_HOME}/modules/module-webservices/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/jettystop.sh" token="${MCR.basedir}" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/jettystop.sh" token="${env.MYCORE_HOME}/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/jettystop.sh" token="${env.MYCORE_HOME}/modules/module-webservices/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/listPlugins.sh" token="${MCR.basedir}" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/listPlugins.sh" token="${env.MYCORE_HOME}/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/listPlugins.sh" token="${env.MYCORE_HOME}/modules/module-webservices/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/mycore.sh" token="${MCR.basedir}" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/mycore.sh" token="${env.MYCORE_HOME}/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/mycore.sh" token="${env.MYCORE_HOME}/modules/module-webservices/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/Save.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/SaveContent.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/SaveContent.sh" token="$MYCORE_HOME/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/SaveDerivate.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/SaveDerivate.sh" token="$MYCORE_HOME/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/SaveList.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/SaveUser.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/SQLCountDB2.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/SQLCountHSQLDB.sh" token="$MYCORE_HOME/lib" value="$INSTALL_PATH/lib/mycore"/>
    <replace file="${docportal.bin}/SQLCountHSQLDB.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/SQLCountMySQL.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <!-- replace in unixtools -->
    <replace file="${docportal.unixtools}/ClassCheck.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/ClassDelete.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/ClassLoad.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/ClassUpdate.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/QueryDoc.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/QueryInst.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/QueryPers.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SAuthCheck.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SAuthDelete.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SAuthLoad.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SAuthUpdate.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SDerDelete.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SDocCheck.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SDocDelete.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SDocDerLoad.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SDocDerUpdate.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SDocLoad.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SDocUpdate.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SInstCheck.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SInstDelete.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SInstLoad.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.unixtools}/SInstUpdate.sh" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
  </target>

  <target name="izpack.prebuild.windows">
    <!-- replace in bin -->
    <replace file="${docportal.bin}/hsqldbadmin.cmd" token="D:\Test\docportal" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/hsqldbadmin.cmd" token="D:\Test\mycore\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/hsqldbadmin.cmd" token="D:\Test\mycore\modules\module-webservices\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/hsqldbstart.cmd" token="D:\Test\docportal" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/hsqldbstart.cmd" token="D:\Test\mycore\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/hsqldbstart.cmd" token="D:\Test\mycore\modules\module-webservices\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/hsqldbstop.cmd" token="D:\Test\docportal" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/hsqldbstop.cmd" token="D:\Test\mycore\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/hsqldbstop.cmd" token="D:\Test\mycore\modules\module-webservices\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/jettystart.cmd" token="D:\Test\docportal" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/jettystart.cmd" token="D:\Test\mycore\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/jettystart.cmd" token="D:\Test\mycore\modules\module-webservices\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/jettystop.cmd" token="D:\Test\docportal" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/jettystop.cmd" token="D:\Test\mycore\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/jettystop.cmd" token="D:\Test\mycore\modules\module-webservices\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/mycore.cmd" token="D:\Test\docportal" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/mycore.cmd" token="D:\Test\mycore\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/mycore.cmd" token="D:\Test\mycore\modules\module-webservices\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/Save.cmd" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/SaveContent.cmd" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/SaveContent.cmd" token="$MYCORE_HOME\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/SaveDerivate.cmd" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/SaveDerivate.cmd" token="$MYCORE_HOME\lib" value="$INSTALL_PATH\lib\mycore"/>
    <replace file="${docportal.bin}/SaveList.cmd" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/SaveUser.cmd" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/SQLCountHSQLDB.cmd" token="$DOCPORTAL_HOME" value="$INSTALL_PATH"/>
    <replace file="${docportal.bin}/SQLCountHSQLDB.cmd" token="$MYCORE_HOME\lib" value="$INSTALL_PATH\lib\mycore"/>
  </target>

  <target name="izpack.build" >
    <delete file="${basedir}/docportal-installable.jar" quiet="true" />
    <taskdef name="izpack-dist" classpath="{env.IZPACK_HOME}/lib/compiler.jar" classname="com.izforge.izpack.ant.IzPackTask" />
    <izpack-dist input="${basedir}/docportal-izpack.xml" output="${basedir}/docportal-installable.jar" installerType="standard" basedir="${basedir}" izPackDir="${env.IZPACK_HOME}" />
  </target>

  <target name="izpack.postbuild" >
    <!-- replace in bin -->
    <antcall target="create.scripts" />
    <replace file="${docportal.bin}/Save.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.bin}/SaveContent.sh" token="$INSTALL_PATH/lib/mycore" value="$MYCORE_HOME/lib"/>
    <replace file="${docportal.bin}/SaveContent.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.bin}/SaveDerivate.sh" token="$INSTALL_PATH/lib/mycore" value="$MYCORE_HOME/lib"/>
    <replace file="${docportal.bin}/SaveDerivate.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.bin}/SaveList.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.bin}/SaveUser.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.bin}/SQLCountDB2.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.bin}/SQLCountHSQLDB.sh" token="$INSTALL_PATH/lib/mycore" value="$MYCORE_HOME/lib"/>
    <replace file="${docportal.bin}/SQLCountHSQLDB.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.bin}/SQLCountMySQL.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <!-- replace in unixtools -->
    <replace file="${docportal.unixtools}/ClassCheck.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/ClassDelete.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/ClassLoad.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/ClassUpdate.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/QueryDoc.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/QueryInst.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/QueryPers.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SAuthCheck.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SAuthDelete.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SAuthLoad.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SAuthUpdate.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SDerDelete.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SDocCheck.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SDocDelete.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SDocDerLoad.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SDocDerUpdate.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SDocLoad.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SDocUpdate.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SInstCheck.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SInstDelete.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SInstLoad.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
    <replace file="${docportal.unixtools}/SInstUpdate.sh" token="$INSTALL_PATH" value="$DOCPORTAL_HOME"/>
  </target>
	
  <target name="delete.mycore">
    <!-- mycore jars -->
    <delete dir="${docportal.mcrlib}" />
    <!-- mycore config -->
    <delete file="${docportal.config}/build.properties" />
    <!-- mycore documentation -->
    <delete file="${docportal.doc}/Overview.pdf" />
    <delete file="${docportal.doc}/UserGuide.pdf" />
    <delete file="${docportal.doc}/ProgrammerGuide.pdf" />
    <delete dir="${docportal.doc}/html" />
  </target>

  <!-- =================================================================== -->
  <!-- Build a jar file with all third party classes                       -->
  <!-- =================================================================== -->

  <target name="third-party">
    <echo level="info">Build third-party.jar</echo>
    <mkdir dir="${build.lib}/third-party" />
    <!-- unpack jar and zip -->
	  <!--
    <unjar dest="${build.lib}/third-party" >
      <fileset dir="${mycore.lib}" includes="*.jar" excludes="mycore.jar" />
	</unjar>
    <unzip dest="${build.lib}/third-party" >
      <fileset dir="${mycore.lib}" includes="*.zip" />
	</unzip>
    <unjar dest="${build.lib}/third-party" >
      <fileset dir="${mycore.modules}" includes="module-*/lib/*.jar" />
	</unjar>
		  -->
    <!-- pack to one jar -->
    <jar destfile="${build.lib}/third-party.jar" >
      <fileset dir="${build.lib}/third-party" includes="**/*" />
    </jar>
	<copy todir="${build.lib}">
      <fileset dir="${mycore.lib}" includes="*.jar" />
      <fileset dir="${mycore.lib}" includes="*.zip" />
      <fileset dir="${mycore.modules}" includes="module-*/lib/*.jar" />
	</copy>
    <!-- remove unpacked jar and zip files -->
    <delete dir="${build.lib}/third-party" />
    <!-- copy license files -->
    <copy todir="${build.lib}" >
      <fileset dir="${mycore.lib}" includes="*.txt" />
      <fileset dir="${mycore.modules}" includes="module-*/lib/*.txt" />		
	</copy>
    <echo level="info">---------------------------------------------------------</echo>
  </target>

  <!-- =================================================================== -->
  <!-- Compiles all application classes                                    -->
  <!-- =================================================================== -->

  <target name="javac" depends="init">
    <echo level="info">Compiling ${packages}</echo>
    <javac srcdir="${docportal.sources}"
           destdir="${build.classes}"
           includes="${packages}"
           classpathref="docportal.classpath"
           debug="${debug}"
           optimize="${optimize}"
           target="${javatarget}"
           source="${sourcerelease}"
           encoding="${sourceencoding}"
           deprecation="${deprecation}">
    </javac>
    <echo level="info">---------------------------------------------------------</echo>
  </target>

  <target name="compile" depends="third-party" description="Compiles all sources under the sample directory" > 
    <echo level="info">Compiling a DocPortal classes...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/**"/>
    </antcall>
    <subant target="compile" inheritall="true" inheritrefs="true">
      <fileset dir="." includes="modules/module-*/build.xml">
      	<containsregexp expression="\u003ctarget.*name=\u0022compile\u0022"/> 
      </fileset>
    </subant>
  </target>

  <!-- =================================================================== -->
  <!-- Creates a docportal.jar file containing all compiled classes        -->
  <!-- =================================================================== -->

  <target name="jar" depends="compile" description="creates lib/docportal.jar">
    <echo level="info">Creating docportal.jar containing all compiled classes.</echo>
    <jar
      destfile="${build.lib}/docportal.jar"
    >
      <fileset dir="${build.classes}" includes="**/*.class"       />
      <fileset dir="${build.schema}"  includes="*.xsd *.dtd"      />
    </jar>
    <echo level="info">---------------------------------------------------------</echo>
  </target>

  <!-- =================================================================== -->
  <!-- Call subant for the WebService module                               -->
  <!-- =================================================================== -->

  <target name="webservice.deploy" description="Call the deploy target for the WebServices">
    <subant target="deploy" inheritall="true" inheritrefs="true" >
      <fileset dir="${docportal}/modules/module-webservices" includes="build.xml" />
    </subant>
  </target>

  <target name="webservice.undeploy" description="Call the undeploy target for the WebServices">
    <subant target="undeploy" inheritall="true" inheritrefs="true" >
      <fileset dir="${docportal}/modules/module-webservices" includes="build.xml" />
    </subant>
  </target>

  <!-- =================================================================== -->
  <!-- Create all metadata stores for XML mapped stores                    -->
  <!-- =================================================================== -->

  <target name="create.metastore" depends="init,create.hibernate" description="Create all metadata stores for XML mapped stores" >
    <mkdir dir="${MCR.Editor.FileUpload.TempStoragePath}" />
    <mkdir dir="${MCR.IFS.ContentStore.FS.URI}" />
    <mkdir dir="${MCR.Save.FileSystem}"  />
    <mkdir dir="${MCR.oai.resumptiontoken.dir}"  />
    <mkdir dir="${MCR.editor_base_directory}" />
    <mkdir dir="${MCR.editor_author_directory}" />
    <mkdir dir="${MCR.editor_document_directory}" />
    <mkdir dir="${MCR.editor_institution_directory}" />
    <mkdir dir="${MCR.Searcher.lucene-metadata.IndexDir}" />
    <mkdir dir="${MCR.Searcher.lucene-content.IndexDir}" />
  </target>

  <target name="create.hibernate" depends="init" if="db.is.hibernate">
    <mkdir dir="${MCR.persistence_sql_data_directory}" />
    <copy todir="${MCR.dtd.directory}" overwrite="true">
      <fileset file="${env.MYCORE_HOME}/schema/hibernate-mapping.dtd"/>
    </copy>
    <antcall target="invoke.cli">
      <param name="cli.directory" value="${docportal}"  />
      <param name="cli.command"   value="init hibernate" />
    </antcall>
  </target>

  <!-- =================================================================== -->
  <!-- Load all classifications                                            -->
  <!-- =================================================================== -->

  <target name="create.class" depends="init" description="Load all classifications">
    <property name="commands.file" value="${basedir}/commands.txt"/>
    <delete file="${commands.file}" />
    <echo file="${commands.file}" append="false">

    update all classifications from directory ${docportal.content}/classification

    </echo>
    <antcall target="invoke.cli">
      <param name="cli.directory" value="${basedir}" />
      <param name="cli.command"   value="process ${commands.file}" />
    </antcall>
    <delete file="${commands.file}" />
  </target>

  <!-- =================================================================== -->
  <!-- Generates the keys to sign the applets                              -->
  <!-- =================================================================== -->

  <target name="create.genkeys" depends="init" description="Generates the keys to sign the applets">
    <loadproperties srcFile="${docportal.config}/mycore.properties.private">
      <filterchain>
        <linecontains>
          <contains value="SIGN."/>
        </linecontains>
      </filterchain>
    </loadproperties>
    <echo level="info">

      Generating a key pair for signing applets ...
    </echo>
                <mkdir dir="${SIGN.KeyStore}" />
                <genkey
      alias     = "${SIGN.Alias}"
      keystore  = "${SIGN.KeyStore}/keys"
      storepass = "${SIGN.Password}"
      keypass   = "${SIGN.Password}"
      validity  = "${SIGN.Validity}"
      >
      <dname>
        <param name="CN" value="${SIGN.Name}"/>
        <param name="OU" value="${SIGN.OrgUnit}"/>
        <param name="O"  value="${SIGN.Organization}"/>
        <param name="C"  value="${SIGN.Country}"/>
      </dname>
    </genkey>
  </target>

  <!-- =================================================================== -->
  <!-- Build the web application directory and copy webpages               -->
  <!-- =================================================================== -->

  <target name="webapps" depends="init,webapps.directories,webapps.base,webapps.i18n,webapps.modules,safeWebContent,webapps.templates" description="Build the complete sample web application directory" >
    <echo level="info">Creating web application in directory ${build.webapps}</echo>
  </target>
	
  <target name="webapps.i18n">
  	<copy todir="${build.webapps}/WEB-INF/classes/" overwrite="true">
  		<fileset dir="${docportal.config}">
  			<include name="messages_*.properties"/>
  		</fileset>
    </copy>
  	<move file="${build.webapps}/WEB-INF/classes/messages_${MCR.metadata_default_lang}.properties" tofile="${build.webapps}/WEB-INF/classes/messages.properties"/>
  	<echo file="${build.webapps}/WEB-INF/classes/messages_${MCR.metadata_default_lang}.properties" append="false">#look for properties in messages.properties</echo>
  </target>

  <target name="webapps.modules">
    <echo level="info">
      do 'webapps' in all modules...
    </echo>
    <subant target="webapps" inheritall="true" inheritrefs="true">
      <fileset dir="${docportal}" includes="modules/module-*/build.xml" />
    </subant>
  </target>
  
  <target name="webapps.directories">
    <!-- Create necessary directories  -->
    <mkdir dir="${build.webapps}"/>
    <mkdir dir="${build.webapps}/editor"/>
    <mkdir dir="${build.webapps}/applet"/>
    <mkdir dir="${build.webapps}/WEB-INF"/>
    <mkdir dir="${build.webapps}/WEB-INF/classes"/>
    <mkdir dir="${build.webapps}/WEB-INF/lib"/>
    <mkdir dir="${build.webapps}/WEB-INF/stylesheets"/>
  </target>

  <target name="webapps.base">
    <!-- Copy editor stylesheets from MyCoRe and the DocPortal Application -->
    <copy file="${mycore}/stylesheets/MCRJDOMSearch.xsl" todir="${build.webapps}/WEB-INF/classes"/>
    <copy file="${mycore}/stylesheets/editor/editor.xsl" todir="${build.webapps}/WEB-INF/stylesheets"/>
    <copy file="${mycore}/stylesheets/editor/editor-common.xsl" todir="${build.webapps}/WEB-INF/stylesheets"/>
    <copy file="${mycore}/stylesheets/editor/helpPopup.xsl" todir="${build.webapps}/WEB-INF/stylesheets"/>
    <copy file="${mycore}/stylesheets/editor/imports-help-popup.xsl" todir="${build.webapps}/WEB-INF/stylesheets"/>

    <!-- Copy the files from various directories to build the webapps -->
    <copy todir="${build.webapps}" preservelastmodified="true">
      <fileset dir="${docportal.webpages}" >
        <exclude name="**/*.xsl" />
      </fileset>
      <fileset dir="${docportal.config}" includes="FileContentTypes.xml" />
      <fileset dir="${docportal.config}" includes="searchfields.xml" />
      <fileset dir="${docportal.config}" includes="hosts.xml" />
      <fileset dir="${docportal.doc}" includes="DocPortal.pdf" />
      <fileset dir="${docportal.doc}" includes="QuickInstallationGuide.pdf" />
      <fileset dir="${mycore}/documentation/Overview" includes="Overview.pdf" />
      <fileset dir="${mycore}/documentation/UserGuide" includes="UserGuide.pdf" />
      <fileset dir="${mycore}/documentation/ProgGuide" includes="ProgrammerGuide.pdf" />
    </copy>
  	
    <copy todir="${build.webapps}/editor">
      <fileset dir="${docportal.config}" includes="editor-*.xml" />
      <fileset dir="${docportal.config}" includes="imports-*.xml" />
    </copy>
    <copy todir="${build.webapps}/WEB-INF">
      <fileset dir="${docportal.config}" includes="web.xml ibm*.xmi" />
      <fileset dir="${mycore}/schema" includes="web-app_2_3.dtd" />
    </copy>
    <copy todir="${build.webapps}/WEB-INF/lib">
      <fileset dir="${mycore}/lib" includes="*.jar" excludes="servlet-api*" />
      <fileset dir="${docportal.lib}" includes="*.jar" />
    </copy>
    <copy todir="${build.webapps}/WEB-INF/classes">
      <fileset dir="${build.classes}" />
      <fileset dir="${docportal.config}" excludes="user/*" />
      <fileset dir="${build.schema}" />
    </copy>
    <copy todir="${build.webapps}/WEB-INF/stylesheets" flatten="true">
      <fileset dir="${docportal.stylesheets}"   includes="**/*.xsl" />
      <fileset dir="${mycore}/stylesheets" includes="**/*.xsl" />
      <!-- templates -->
      <fileset dir="${basedir}/webpages/templates/master">
        <include name="**/*.xsl" />
      </fileset>
    </copy>

    <echo level="info">

      Building the upload applet used for file uploads...
    </echo>
    <!-- Compile applet to JDK 1.4 -->
	<mkdir dir="${build.webapps}/applet/sources" />
	<mkdir dir="${build.webapps}/applet/classes" />
    <copy todir="${build.webapps}/applet/sources">
      <fileset dir="${mycore}/sources">
        <include name="org/mycore/frontend/fileupload/MCRUploadAppl*.java"/>
        <include name="org/mycore/frontend/fileupload/MCRUploadComm*r.java"/>
        <include name="org/mycore/frontend/fileupload/MCRUploadExce*.java"/>
        <include name="org/mycore/frontend/fileupload/MCRUploadProg*.java"/>
      </fileset>		
	</copy>
    <javac srcdir="${build.webapps}/applet/sources"
           destdir="${build.webapps}/applet/classes"
           includes="org/mycore/**"
           classpathref="docportal.classpath"
           debug="${debug}"
           optimize="${optimize}"
           target="1.4"
           source="1.4"
           encoding="${sourceencoding}"
           deprecation="${deprecation}">
    </javac>
    <!-- build applet jar -->
  	<copy file="${mycore.config}/messages_de.MCRUploadApplet" tofile="${build.webapps}/applet/messages_de.properties"/>
  	<copy file="${mycore.config}/messages_en.MCRUploadApplet" tofile="${build.webapps}/applet/messages_en.properties"/>
    <jar jarfile="${build.webapps}/applet/unsigned.jar">
      <fileset dir="${build.webapps}/applet/classes">
        <include name="org/mycore/frontend/fileupload/MCRUploadAppl*.class"/>
        <include name="org/mycore/frontend/fileupload/MCRUploadComm*r.class"/>
        <include name="org/mycore/frontend/fileupload/MCRUploadExce*.class"/>
        <include name="org/mycore/frontend/fileupload/MCRUploadProg*.class"/>
      </fileset>
      <fileset dir="${build.webapps}/applet">
        <include name="messages*"/>
        <include name="mycore.properties*"/>
      </fileset>
    </jar>
    <loadproperties srcFile="${docportal.config}/mycore.properties.private">
      <filterchain>
        <linecontains>
          <contains value="SIGN."/>
        </linecontains>
      </filterchain>
    </loadproperties>
    <signjar
      jar       = "${build.webapps}/applet/unsigned.jar"
      signedjar = "${build.webapps}/applet/upload.jar"
      alias     = "${SIGN.Alias}"
      keystore  = "${SIGN.KeyStore}/keys"
      storepass = "${SIGN.Password}"
      keypass   = "${SIGN.Password}"
    />
    <delete file="${build.webapps}/applet/unsigned.jar"/>
    <chmod dir="${build.webapps}/applet" perm="ugo+r"/>

    <!-- Copy the web.xml of the core to the webapps -->
    <delete file="${build.webapps}/WEB-INF/web.xml" />
    <copy file="${mycore.config}/web.xml" todir="${build.webapps}/WEB-INF" />

    <antcall target="copy.webapp.shared.jars" />
    <antcall target="webapp.info.shared.jars" />
    <antcall target="webapp.info.unix" />

    <!-- Copy / Unpack fckEditor files (WYSIWYG HTML Editor) -->
    <unzip src="${env.MYCORE_HOME}/lib/fckEditor.zip" dest="${build.webapps}" />
    <copy file="${env.MYCORE_HOME}/config/fckconfig.js" todir="${build.webapps}/fck" />

    <!-- Replace URL in browser search plug-in -->
    <copy todir="${build.webapps}" overwrite="yes">
      <fileset dir="${docportal.webpages}" includes="docportal-plugin.xml docportal-plugin.src" />
      <filterchain>
        <tokenfilter>
          <replacestring from="%MCR.baseurl%" to="${MCR.baseurl}"/>
        </tokenfilter>
      </filterchain>
    </copy>
  </target>
	
  <!-- create a new chooseTemplate.xsl -->	
  <target name="webapps.templates">
  	<taskdef name="templatecheck" classname="org.mycore.common.MCRTemplateTask" classpathref="docportal.classpath" />
  	<templatecheck templatepath="${env.DOCPORTAL_HOME}/webpages/templates/master/"
  		choosepath="${build.webapps}/WEB-INF/stylesheets/chooseTemplate.xsl" />
  </target>		
	
  <!-- save modified static web content -->	
  <target name="safeWebContent">
	    <copy todir="${docportal.webpages}/config/" preservelastmodified="true" failonerror="false">
	      <fileset file="${build.webapps}/config/navigation.xml" />
	    </copy>  	
	    <copy todir="${docportal.webpages}/content" preservelastmodified="true" failonerror="false">
	      <fileset dir="${build.webapps}/content" />
	    </copy>  	
	    <copy todir="${docportal.webpages}/templates" preservelastmodified="true" failonerror="false">
	      <fileset dir="${build.webapps}/templates" />
	    </copy>  	  
	    <copy todir="${docportal.webpages}/images" preservelastmodified="true" failonerror="false">
	      <fileset dir="${build.webapps}/images/" />
	    </copy>  	
	    <copy todir="${docportal.webpages}/documents" preservelastmodified="true" failonerror="false">
	      <fileset dir="${build.webapps}/documents" />
	    </copy>  	
  </target>

  <target name="webapp.info.shared.jars" unless="MCR.WebAppServer.SharedJarsDir">
    <echo level="info">
      NOTE: MyCoRe copied the jar files listed above as specified by MCR.XMLStore.Jars and MCR.JDBCStore.Jars to the web applicaton WEB-INF/lib directory.
            Your build.properties configuration file lists them as needed to connect to your local XML database and/or JDBC database system.
            If these files load native libraries to connect to the database, this may cause trouble at runtime when you run multiple web applications in the same JVM or use dynamic servlet reloading. In this case, put these jars in a separate directory where they are just loaded once, for tomcat for example move these files to the directory 'shared'. Set the propery MCR.WebAppServer.SharedJarsDir in build.properties to control this.
    </echo>
  </target>

  <target name="webapp.info.unix" if="os.is.unix">
    <echo level="info">
      NOTE: For UNIX systems like AIX, Linux, set the environment variables LIBPATH and LD_LIBRARY_PATH as needed for your database system.
            From your configuration in build.properties, MyCoRe suggests to set these variables as follows:

      LIBPATH=${docportal.libpath.translated}
      LD_LIBRARY_PATH=$LIBPATH

    </echo>
  </target>

  <target name="copy.webapp.shared.jars">
    <delete dir="${build.webapps}/WEB-INF/lib/tmp" />
    <mkdir  dir="${build.webapps}/WEB-INF/lib/tmp" />
    <antcall target="copy.webapp.jdbc" />
    <antcall target="copy.webapp.xml"  />
    <antcall target="copy.webapp.system"  />
    <condition property="shared.jars.dir" value="${MCR.WebAppServer.SharedJarsDir}">
      <available file="${MCR.WebAppServer.SharedJarsDir}" type="dir" />
    </condition>
    <condition property="shared.jars.dir" value="${build.webapps}/WEB-INF/lib">
      <not>
        <available file="${MCR.WebAppServer.SharedJarsDir}" type="dir" />
      </not>
    </condition>
    <antcall target="list.jars.unix" />
    <antcall target="list.jars.windows" />
    <move toDir="${shared.jars.dir}">
      <fileset dir="${build.webapps}/WEB-INF/lib/tmp" includes="*" />
    </move>
    <delete dir="${build.webapps}/WEB-INF/lib/tmp" />
  </target>

  <target name="list.jars.unix" if="os.is.unix">
    <exec dir="${build.webapps}/WEB-INF/lib/tmp" executable="ls" />
  </target>

  <target name="list.jars.windows" if="os.is.windows">
    <exec dir="${build.webapps}/WEB-INF/lib/tmp" executable="cmd.exe" >
      <arg line="/c dir *.*"/>
    </exec>
  </target>

  <target name="copy.webapp.jdbc" if="MCR.JDBCStore.BaseDir">
    <copy todir="${build.webapps}/WEB-INF/lib/tmp" flatten="true">
      <fileset dir="${MCR.JDBCStore.BaseDir}" includes="_dummy_ ${MCR.JDBCStore.Jars}" />
    </copy>
  </target>

  <target name="copy.webapp.xml" if="MCR.XMLStore.BaseDir">
    <copy todir="${build.webapps}/WEB-INF/lib/tmp" flatten="true">
      <fileset dir="${MCR.XMLStore.BaseDir}" includes="_dummy_ ${MCR.XMLStore.Jars}" />
    </copy>
  </target>
	
  <target name="copy.webapp.system" if="MCR.System.SharedJarsDir">
    <copy todir="${build.webapps}/WEB-INF/lib/tmp" flatten="true">
      <fileset dir="${MCR.System.SharedJarsDir}" includes="_dummy_ ${MCR.System.Jars}" />
    </copy>
  </target>

  <!-- =================================================================== -->
  <!-- Build a web application archive                                     -->
  <!-- =================================================================== -->

  <target name="war" depends="webapps" description="Build web application archive (war)" >
    <jar jarfile="${build}/docportal.war" basedir="${build.webapps}" />
  </target>

  <!-- =================================================================== -->
  <!-- Remove the user created directories and files                       -->
  <!-- =================================================================== -->

  <target name="clean" depends="safeWebContent,clean.system" description="Removes all generated files, cleaning up" />

  <target name="clean.system" description="Removes only all system files, cleaning up" >
    <!-- Remove all build files -->
    <delete dir="${build}" />
  </target>

  <target name="clean.data" description="Removes only all data files, cleaning up" >
    <delete dir="${MCR.IFS.ContentStore.FS.URI}" />
    <delete dir="${MCR.editor_base_directory}"/>
    <delete dir="${MCR.Editor.FileUpload.TempStoragePath}"/>
    <delete dir="${MCR.Searcher.lucene-metadata.IndexDir}"/>
    <delete dir="${MCR.Searcher.lucene-content.IndexDir}"/>
    <delete dir="${MCR.Lucene.LockDir}"/>
    <antcall target="clean.directories.sql_data" />
  </target>

  <target name="clean.directories.sql_data" if="MCR.persistence_sql_data_directory">
    <delete dir="${MCR.persistence_sql_data_directory}" />
  </target>

  <!-- =================================================================== -->
  <!-- Update current working directory from CVS repository                -->
  <!-- =================================================================== -->

  <target name="update">
    <cvs
      cvsroot="${CVSRoot}"
      command="update -dP"
      dest="${basedir}"
    />
  </target>

  <!-- =================================================================== -->
  <!-- Do work after a CVS commit...                                       -->
  <!-- =================================================================== -->

  <target name="postcommit">
    <antcall target="update" />
    <antcall target="javadocs" />
    <antcall target="changelog" />
  </target>

  <!-- =================================================================== -->
  <!-- Build CVS ChangeLog                                                 -->
  <!-- =================================================================== -->

  <target name="changelog" depends="init">
    <echo level="info">

      Building CVS ChangeLog, please be patient...
    </echo>

    <tstamp>
      <format property="year" pattern="yyyy" />
    </tstamp>

    <mkdir dir="${basedir}/changelogs" />
    <mkdir dir="${basedir}/changelogs/${year}" />

    <exec executable="/mcr/applications/cvschangelogbuilder-2.0/cvschangelogbuilder.pl">
      <arg value="-module=docportal" />
      <arg value="-output=buildhtmlreport" />
      <arg value="-viewcvsurl=http://www.mycore.de/cvs/viewcvs.cgi" />
      <arg value="-dir=${basedir}/changelogs/${year}" /> 
    </exec>

    <move file="${basedir}/changelogs/${year}/cvschangelogbuilder_docportal.html" tofile="${basedir}/changelogs/${year}/index.html" />

    <chmod dir="${basedir}/changelogs" perm="ugo+rx" />
    <chmod dir="${basedir}/changelogs" type="dir"  perm="ugo+rx" includes="**/*" />
    <chmod dir="${basedir}/changelogs" type="file" perm="ugo+r"  includes="**/*" />
  </target>

  <!-- =================================================================== -->
  <!-- Check if javadocs and pdf are up to date or outdated                -->
  <!-- =================================================================== -->

  <target name="up2date" depends="init">

    <path id="javadocs.classpath">
      <fileset dir="${basedir}/lib" includes="*.jar"/>
      <fileset dir="${env.MYCORE_HOME}/lib" includes="*.jar"/>
    </path>

    <condition property="javadocs.outdated">
      <not>
        <uptodate>
          <srcfiles dir="${basedir}/sources" includes="**/*.java" />
          <mapper type="merge" to="${basedir}/javadocs/overview-tree.html"/>
        </uptodate>
      </not>
    </condition>
  </target>

  <!-- =================================================================== -->
  <!-- Create the HTML JavaDocs from sources                               -->
  <!-- =================================================================== -->

  <target name="javadocs" depends="up2date" if="javadocs.outdated" description="creates JavaDoc API documentation in HTML format">
    <echo level="info">Building the DocPortal JavaDoc API documentation...</echo>
    
    <mkdir dir="${basedir}/javadocs" />
    <javadoc
      packagenames        = "org.mycore.*"
      sourcepath          = "${basedir}/sources"
      destdir             = "${basedir}/javadocs"
      classpathref        = "javadocs.classpath"
      author              = "true"
      version             = "true"
      use                 = "true"
      access              = "package"
      splitindex          = "true"
      linksource          = "true"
      windowtitle         = "DocPortal JavaDoc Documentation"
      doctitle            = "DocPortal Source Code JavaDoc Documentation"
    >
      <group title="DocPortal Datamodel"                           packages="org.mycore.datamodel*" />
      <group title="DocPortal Persistence Backend Implementations" packages="org.mycore.backend*"   />
      <group title="DocPortal User Interface Frontend"             packages="org.mycore.frontend*"  />
      <group title="DocPortal Sample"                              packages="org.mycore.sample*"    />

      <link href="http://java.sun.com/j2se/1.4.2/docs/api/"/>
      <link href="http://www.mycore.de/workdir/mycore/documentation/html"/>
      <link href="http://www.mycore.de/library/cm-eip/eip-8.2-javadocs/" />
      <link href="http://jakarta.apache.org/tomcat/tomcat-5.0-doc/servletapi"/>
      <link href="http://java.sun.com/xml/jaxp/dist/1.1/docs/api/"/>
      <link href="http://www.jdom.org/docs/apidocs"/>
      <link href="http://xmldb-org.sourceforge.net/xapi/api/"/>
      <link href="http://logging.apache.org/log4j/docs/api/"/>
      <link href="http://jakarta.apache.org/lucene/docs/api/" />
    </javadoc>
    <echo level="info">---------------------------------------------------------</echo>

    <chmod dir="${basedir}/javadocs" type="file" perm="ugo+r"  includes="**/*" />
    <chmod dir="${basedir}/javadocs" type="dir"  perm="ugo+rx" includes="**/*" />
  </target>

    <!-- =================================================================== -->
    <!-- Load privileges, users and groups into database                     -->
    <!-- =================================================================== -->

  <target name="create.users" depends="init" description="Load privileges, users and groups into database">
    <property name="commands.file" value="${basedir}/commands.txt"/>
    <echo file="${commands.file}" append="false">

      load permissions data from file permissions.xml

      init superuser

      change to user root with alleswirdgut

      create group data from file group_admingroup.xml
      create user data from file user_administrator.xml
      change to user administrator with alleswirdgut

      create group data from file group_readergroup1.xml
      create group data from file group_authorgroup1.xml
      create group data from file group_editorgroup1.xml
      create user data from file user_reader1A.xml
      create user data from file user_author1A.xml
      create user data from file user_author1B.xml
      create user data from file user_editor1A.xml
      create user data from file user_editor1B.xml

      create group data from file group_readergroup2.xml
      create group data from file group_authorgroup2.xml
      create group data from file group_editorgroup2.xml
      create user data from file user_reader2A.xml
      create user data from file user_author2A.xml
      create user data from file user_author2B.xml
      create user data from file user_editor2A.xml
      create user data from file user_editor2B.xml

      check user data consistency

    </echo>
    <antcall target="invoke.cli">
      <param name="cli.directory" value="${basedir}/config/user"  />
      <param name="cli.command"   value="process ${commands.file}" />
    </antcall>
    <delete file="${commands.file}" />
  </target>

    <!-- =================================================================== -->
    <!-- Load default ACL rules                                              -->
    <!-- =================================================================== -->

  <target name="create.default-rules" depends="init" description="Load default ACL rules">
    <property name="commands.file" value="${basedir}/commands.txt"/>
    <echo file="${commands.file}" append="false">
    	update permission read for id default with rulefile grant-all.xml
    	update permission writedb for id default with rulefile grant-editors.xml
    	update permission deletedb for id default with rulefile grant-admins.xml
    </echo>
  	<!-- this demonstrates how to specify default rules on a basis of an object type -->
    <echo file="${commands.file}" append="true">
    	update permission read for id default_document with rulefile grant-all.xml
    	update permission writedb for id default_document with rulefile grant-editors.xml
    	update permission deletedb for id default_document with rulefile grant-admins.xml
    </echo>
    <antcall target="invoke.cli">
      <param name="cli.directory" value="${basedir}/config/acl"  />
      <param name="cli.command"   value="process ${commands.file}" />
    </antcall>
    <delete file="${commands.file}" />
  </target>

    <!-- =================================================================== -->
    <!-- Generate Hibernate getter/setter class                              -->
    <!-- =================================================================== -->

  <target name="create.hibindexer" description="dynamic class generation">
     <echo level="info" message="Generating Hibernate getter/setter class for query" />
     <property file="${docportal.config}/mycore.properties.query" />
     <mkdir dir="${basedir}/sources/org/mycore/backend/query" />
     <java classname="org.mycore.backend.query.helper.GenClasses"
        classpathref="docportal.classpath"
        fork="true">
        <arg value="${docportal.sources}/org/mycore/backend/query" />
     </java>
  </target>

  <!-- =================================================================== -->
  <!-- Generate search mask from searchfields.xml                          -->
  <!-- =================================================================== -->

  <target name="create.searchmask" description="Generate search mask from searchfields.xml" depends="init">
		
    <!-- Filename of the editor definition file that defines the search mask form -->
    <property name="filename.editor"  value="editor-search-generated.xml" />
    <!-- Filename of the webpage that contains the search mask -->
    <property name="filename.webpage" value="editor_form_search-generated.xml" />
    <!-- i18n key of search mask headline -->
    <property name="headline.i18n" value="editor.search.document.label" />
    <!-- Title of webpage in German -->
    <property name="title.de" value="Suche nach Dokumenten" />
    <!-- Title of webpage in English -->
    <property name="title.en" value="Search for documents" />
    <!-- ID of the search index(es) to include, multiple indexes separated by blanks -->
    <!-- If this property is set, by default all fields in those indexes are included -->
    <property name="search.indexes" value="" />
    <!-- Name(s) of the search fields to skip, separated by blanks. -->
    <!-- If this property and search.indexes is set, the listed fields are NOT included in search mask -->
    <property name="skip.fields" value="" />
    <!-- Name(s) of the search fields to include, separated by blanks. -->
    <!-- If this property is set, ONLY these search fields will be included in search mask -->
    <property name="search.fields" value="title author creator publisher contributor origin subject format language type keywords description source coverage rights relation dateCreated identifier" />
    <!-- Optional restriction (hidden condition) for search -->
    <!-- Syntax: "field operator value", separated by blanks -->
    <!-- Example: "objectType = document" -->
    <property name="restriction" value="objectType = document" />
    <!-- List of fields to include as sort criteria of results -->
    <!-- If empty, sort panel is not displayed -->
    <property name="sort.fields" value="title dateCreated" />
    <!-- If true, include a panel to select hosts to query -->
    <property name="include.hostsSelectionPanel" value="true" />
  	<!-- Layout of search mask: simple or advanced -->
  	<!-- simple: one line per field, default operator, combine conditions with and -->
  	<!-- advanced: choose fields and operators from drop-down list, choose and/or -->
  	<property name="layout" value="advanced" />
		
  	<echo level="info">Generating search mask from searchfields.xml</echo>
  	
    <copy file="${mycore.config}/fieldtypes.xml" toDir="${docportal.config}" />
    <xslt basedir="${docportal.config}"
          classpathref="docportal.classpath"
          in="${docportal.config}/searchfields.xml"
          style="${mycore.stylesheets}/searchfields2searchmask.xsl"
          out="${docportal.config}/${filename.editor}"
    	    force="true">
      <param name="mode" expression="editor" />
      <param name="filename.webpage" expression="${filename.webpage}" />
      <param name="headline.i18n" expression="${headline.i18n}" />
      <param name="search.indexes" expression="${search.indexes}" />
      <param name="search.fields" expression="${search.fields}" />
      <param name="skip.fields" expression="${skip.fields}" />
    	<param name="restriction" expression="${restriction}" />
      <param name="sort.fields" expression="${sort.fields}" />
      <param name="include.hostsSelectionPanel" expression="${include.hostsSelectionPanel}" />
    	<param name="layout" expression="${layout}" />
    </xslt>
  	<echo level="info">Generated editor definition file ${filename.editor}</echo>
    <xslt basedir="${docportal.config}"
          classpathref="docportal.classpath"
          in="${docportal.config}/searchfields.xml"
          style="${mycore.stylesheets}/searchfields2searchmask.xsl"
          out="${docportal.webpages}/${filename.webpage}"
    	    force="true">
      <param name="mode" expression="webpage" />
      <param name="filename.editor" expression="${filename.editor}" />
      <param name="title.de" expression="${title.de}" />
      <param name="title.en" expression="${title.en}" />
    </xslt>
  	<echo level="info">Generated webpage ${filename.webpage}</echo>
    <delete file="${docportal.config}/fieldtypes.xml" />
  </target>
	
</project>

<!-- ======================== End of file ======================== -->

